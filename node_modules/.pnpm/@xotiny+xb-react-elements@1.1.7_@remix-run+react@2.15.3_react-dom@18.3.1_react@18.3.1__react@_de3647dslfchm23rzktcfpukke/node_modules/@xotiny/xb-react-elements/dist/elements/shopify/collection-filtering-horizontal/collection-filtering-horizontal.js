import { jsx as _jsx, jsxs as _jsxs, Fragment as _Fragment } from "react/jsx-runtime";
import { Link, useLocation, useSearchParams } from '@remix-run/react';
import { FilterCollectionItem } from "../../../components/filter-collection-item";
import { PriceRangeFilter } from "../../../components/price-range-filter";
import { CONFIG } from "../../../config";
import { useCollectionDetail, useElementSettings } from "../../../hooks/use-shopify-data";
import { getFilterLink } from "../../../utils/get-collection-filter";
import { elementAttr } from "../../../utils/template-helpers/element-attr";
import { classNames } from "../../../utils/class-names";
import './styles';
export const CollectionFilteringHorizontal = ({ element }) => {
    const { settings } = element;
    const parentSettings = useElementSettings();
    const data = useCollectionDetail();
    const [params] = useSearchParams();
    const location = useLocation();
    if (!parentSettings || !data || parentSettings.$filterEnabled !== 'yes') {
        return null;
    }
    const { appliedFilters, collection, collections } = data;
    if (!collection) {
        return null;
    }
    const filterMarkup = (filter, option) => {
        switch (filter.type) {
            case 'PRICE_RANGE':
                const priceFilter = params.get(`${CONFIG.collectionPage.filterUrlPrefix}price`);
                const price = priceFilter ? JSON.parse(priceFilter) : undefined;
                const min = isNaN(Number(price?.min)) ? undefined : Number(price?.min);
                const max = isNaN(Number(price?.max)) ? undefined : Number(price?.max);
                return _jsx(PriceRangeFilter, { min: min, max: max });
            default:
                const to = getFilterLink(option.input, params, location);
                const isActive = appliedFilters.some(fil => JSON.stringify(fil.filter) === option.input);
                const activeClass = isActive ? 'xb-field-checkbox-1--active' : '';
                return (_jsxs(Link, { className: classNames('xb-field-checkbox-1', activeClass), prefetch: "intent", to: to, style: {
                        '--icon-size': '16px',
                    }, children: [_jsx("span", { className: "xb-field-checkbox-1__item", children: _jsx("span", { className: "xb-field-checkbox-1__icon", children: _jsx("svg", { xmlns: "http://www.w3.org/2000/svg", width: "20", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", children: _jsx("polyline", { points: "20 6 9 17 4 12" }) }) }) }), _jsxs("span", { className: "xb-field-checkbox-1__label", children: [_jsx("span", { children: option.label }), parentSettings.$numberCountEnabled == 'yes' && _jsxs("div", { children: ["(", option.count, ")"] })] })] }));
        }
    };
    return (_jsxs("div", { ...elementAttr(element, {
            classNames: ['xb-collection-filtering-horizontal', settings?.modifier?.handle, settings.static?.class],
        }), children: [_jsxs("div", { className: "xb-fieldset-popover", children: [_jsxs("xo-popover-trigger", { class: "xb-fieldset-popover__trigger", "xo-name": element.id, tabIndex: 0, role: "button", children: [_jsx("div", { className: "xb-fieldset-popover__label", children: "Collections" }), _jsx("svg", { xmlns: "http://www.w3.org/2000/svg", width: "15", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", children: _jsx("polyline", { points: "6 9 12 15 18 9" }) })] }), _jsx("xo-popover", { "xo-placement": "bottom-left", "xo-name": element.id, "xo-portal": true, children: _jsx("div", { className: "xb-fieldset-popover__popover", children: _jsx("div", { className: "xb-fieldset-popover__content xb-scrollbar", children: collections.map(collection => {
                                    return _jsx(FilterCollectionItem, { collection: collection }, collection.handle);
                                }) }) }) })] }), collection?.products?.filters?.map(filter => {
                const name = filter.label.toLocaleLowerCase();
                if (name === 'category') {
                    return null;
                }
                return (_jsx("div", { className: "xb-collapse", children: _jsxs("div", { className: "xb-fieldset-popover", children: [_jsxs("xo-popover-trigger", { class: "xb-fieldset-popover__trigger", "xo-name": `xb-fieldset-popover-${filter.id}`, children: [_jsx("div", { className: "xb-fieldset-popover__label", children: filter.label }), _jsx("svg", { xmlns: "http://www.w3.org/2000/svg", width: "15", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round", children: _jsx("polyline", { points: "6 9 12 15 18 9" }) })] }), _jsx("xo-popover", { "xo-name": `xb-fieldset-popover-${filter.id}`, "xo-placement": "bottom-left", "xo-portal": true, style: { opacity: 0 }, children: _jsxs("div", { className: "xb-fieldset-popover__popover xb-scrollbar", children: [_jsx("div", { className: "xb-fieldset-popover__heading", children: filter.type === 'PRICE_RANGE'
                                                ? (() => {
                                                    const priceFilter = params.get(`${CONFIG.collectionPage.filterUrlPrefix}price`);
                                                    const price = priceFilter ? JSON.parse(priceFilter) : undefined;
                                                    const max = isNaN(Number(price?.max)) ? undefined : Number(price?.max);
                                                    return (_jsxs(_Fragment, { children: [_jsxs("div", { className: "xb-fieldset-popover__caption", children: ["The highest price is ", max] }), _jsx("div", { className: "xb-fieldset-popover__caption-icon", children: "Reset" })] }));
                                                })()
                                                : (() => {
                                                    const count = filter?.values?.filter?.(option => appliedFilters.some(fil => JSON.stringify(fil.filter) === option.input))?.length ?? 0;
                                                    return (_jsxs(_Fragment, { children: [_jsxs("div", { className: "xb-fieldset-popover__caption", children: [count, " selected"] }), _jsx(Link, { to: location.pathname, className: "xb-fieldset-popover__caption-icon", children: "Clear" })] }));
                                                })() }), _jsx("div", { className: "xb-fieldset-popover__content xb-scrollbar", children: filter?.values?.map(option => {
                                                return _jsx("div", { children: filterMarkup(filter, option) }, option.id);
                                            }) })] }) })] }) }, filter.id));
            })] }));
};
